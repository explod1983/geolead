{% extends "base.html" %}
{% block title %}Submit · {{ board.name }}{% endblock %}
{% block content %}
  <h1>Submit to {{ board.name }}</h1>

  {% if limit_reached %}
    <div class="card" style="max-width:600px;">
      <p>You’ve already submitted today for this board. Try another board, or come back tomorrow. ✋</p>
      <p style="margin-top:10px;">
        <a class="btn" href="/board/{{ board.slug }}">Back to board</a>
      </p>
    </div>
  {% else %}
    <div class="card" style="max-width:860px;">
      <form method="post" action="/board/{{ board.slug }}/submit" class="form" id="submit-form">
        <div class="grid-3">
          <div>
            <label>Round 1</label>
            <input type="number" name="round1" min="0" max="5000" required>
          </div>
          <div>
            <label>Round 2</label>
            <input type="number" name="round2" min="0" max="5000" required>
          </div>
          <div>
            <label>Round 3</label>
            <input type="number" name="round3" min="0" max="5000" required>
          </div>
        </div>

        <div class="grid-3 paste-grid">
          <div class="paste-wrap">
            <label>Screenshot — Round 1</label>
            <div class="paste-box" tabindex="0" data-target="shot-r1">
              <span class="hint">Click and press <b>Ctrl/⌘+V</b></span>
              <img id="preview-r1" alt="" style="display:none" />
            </div>
            <input type="hidden" name="screenshot_r1" id="shot-r1">
          </div>

          <div class="paste-wrap">
            <label>Screenshot — Round 2</label>
            <div class="paste-box" tabindex="0" data-target="shot-r2">
              <span class="hint">Click and press <b>Ctrl/⌘+V</b></span>
              <img id="preview-r2" alt="" style="display:none" />
            </div>
            <input type="hidden" name="screenshot_r2" id="shot-r2">
          </div>

          <div class="paste-wrap">
            <label>Screenshot — Round 3</label>
            <div class="paste-box" tabindex="0" data-target="shot-r3">
              <span class="hint">Click and press <b>Ctrl/⌘+V</b></span>
              <img id="preview-r3" alt="" style="display:none" />
            </div>
            <input type="hidden" name="screenshot_r3" id="shot-r3">
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
          <button class="btn" type="submit">Submit</button>
          <a class="btn ghost" href="/board/{{ board.slug }}">Cancel</a>
        </div>
      </form>
    </div>
  {% endif %}

  <p class="muted" style="margin-top:12px;">
    After submitting, you can view everyone’s results and screenshots on
    <a href="/board/{{ board.slug }}/today">Today’s round</a>.
  </p>

<script>
document.addEventListener('DOMContentLoaded', () => {
  async function uploadBlob(blob){
    const fd = new FormData();
    fd.append('image', blob, 'paste.png');
    const r = await fetch('/api/paste_image', { method:'POST', body: fd });
    if(!r.ok) throw new Error('upload failed');
    const j = await r.json();
    return j.url;
  }

  function bindPaste(box){
    const targetId = box.dataset.target;
    const input = document.getElementById(targetId);
    const prev  = document.getElementById('preview-' + targetId.split('-')[1]);

    box.addEventListener('paste', async (e) => {
      const items = e.clipboardData?.items || [];
      const imgItem = Array.from(items).find(x => x.type.startsWith('image/'));
      if (!imgItem) return;
      e.preventDefault();
      try{
        const blob = imgItem.getAsFile();
        prev.src = URL.createObjectURL(blob);
        prev.style.display = 'block';
        box.classList.add('has-image');
        const url = await uploadBlob(blob);
        input.value = url;
      }catch(err){
        console.error(err);
        alert('Could not read/upload pasted image.');
      }
    });
  }

  document.querySelectorAll('.paste-box').forEach(bindPaste);
});
</script>
{% endblock %}
