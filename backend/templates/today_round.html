{% extends "base.html" %}

{% block extra_head %}
  <!-- Leaflet CSS (for maps) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-o9N1j7kP5P3p2RbC+qcVP6A0bMsxi9p+R0uVQ4v1pPk="
    crossorigin=""
  />
{% endblock %}

{% block content %}

  <h1>Today’s round · {{ board.name }}</h1>

  {% if posts|length == 0 %}
    <p class="muted">No posts yet for today.</p>
  {% else %}
    <div class="posts">
      {% for p in posts %}
        {% set player_idx = loop.index0 %}
        <article class="card post">
          <header class="post-header">
            <div class="post-title">
              <span class="player">{{ p.name }}</span>
              <span class="meta">
                R1 {{ p.r1 }} · R2 {{ p.r2 }} · R3 {{ p.r3 }} ·
                <strong>Total {{ "{:,}".format(p.total) }}</strong>
                {% if p.total_distance_km is not none %}
                  · {{ (p.total_distance_km)|round(1) }} km
                {% endif %}
              </span>
            </div>
            <time class="time">{{ p.time }}</time>
          </header>

          <div class="rounds">
            {% for r in p.rounds %}
              <div class="round"
                   data-player-index="{{ player_idx }}"
                   data-round-index="{{ r.index }}"
                   data-has-map="{{ '1' if r.has_map else '0' }}"
                   data-guess-lat="{{ r.guess_lat if r.guess_lat is not none else '' }}"
                   data-guess-lng="{{ r.guess_lng if r.guess_lng is not none else '' }}"
                   data-target-lat="{{ r.target_lat if r.target_lat is not none else '' }}"
                   data-target-lng="{{ r.target_lng if r.target_lng is not none else '' }}">
                <div class="round-head">
                  R{{ r.index }}
                  {% if r.distance_m %}
                    · {{ (r.distance_m / 1000.0)|round(1) }} km
                  {% endif %}
                  {% if r.score %}
                    · {{ r.score }} pts
                  {% endif %}
                </div>

                {% if r.has_map %}
                  <!-- Imported GeoGuessr game: show map -->
                  <div class="round-map" id="map-{{ player_idx }}-{{ r.index }}"></div>

                {% elif r.has_screenshot and r.screenshot_url %}
                  <!-- Manual entry: show screenshot -->
                  <img
                    class="shot"
                    src="{{ r.screenshot_url }}"
                    alt="Round {{ r.index }} screenshot for {{ p.name }}"
                    data-fullsrc="{{ r.screenshot_url }}"
                    data-caption="{{ p.name }} – Round {{ r.index }}{% if r.score %} · {{ r.score }} pts{% endif %}{% if r.distance_m %} · {{ (r.distance_m / 1000.0)|round(1) }} km{% endif %}"
                  />

                {% else %}
                  <!-- No map and no screenshot -->
                  <div class="shot shot-empty">No map or screenshot</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Screenshot lightbox markup -->
  <div class="image-lightbox" id="image-lightbox">
    <span class="image-lightbox-close" id="image-lightbox-close">&times;</span>
    <img id="image-lightbox-img" src="" alt="Screenshot" />
    <div class="image-lightbox-caption" id="image-lightbox-caption"></div>
  </div>

  <!-- Leaflet JS + map renderer -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o8UgE19ES3QnE/kV1l1obTNT5hzuC1Lpp3CqkMk8W+8="
    crossorigin=""
  ></script>

  <script>
    // Maps for imported GeoGuessr games
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof L === 'undefined') {
        console.warn('Leaflet not loaded');
        return;
      }

      const maps = document.querySelectorAll('.round-map');
      maps.forEach((el) => {
        const round = el.closest('.round');
        if (!round) return;
        if (round.dataset.hasMap !== '1') return;

        const gLat = parseFloat(round.dataset.guessLat);
        const gLng = parseFloat(round.dataset.guessLng);
        const tLat = parseFloat(round.dataset.targetLat);
        const tLng = parseFloat(round.dataset.targetLng);

        if (
          Number.isNaN(gLat) || Number.isNaN(gLng) ||
          Number.isNaN(tLat) || Number.isNaN(tLng)
        ) {
          return;
        }

        const map = L.map(el, {
          attributionControl: false,
          zoomControl: false,
        });

        const guess = [gLat, gLng];
        const target = [tLat, tLng];
        const bounds = L.latLngBounds([guess, target]);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18,
        }).addTo(map);

        L.circleMarker(guess, {
          radius: 6,
          color: '#4ade80',
          fillColor: '#4ade80',
          fillOpacity: 0.9,
        }).addTo(map);

        L.circleMarker(target, {
          radius: 6,
          color: '#f87171',
          fillColor: '#f87171',
          fillOpacity: 0.9,
        }).addTo(map);

        L.polyline([guess, target], {
          weight: 2,
          color: '#e5e7eb',
        }).addTo(map);

        map.fitBounds(bounds.pad(0.4));
      });
    });

    // Lightbox for screenshots
    document.addEventListener('DOMContentLoaded', () => {
      const lightbox = document.getElementById('image-lightbox');
      const imgEl = document.getElementById('image-lightbox-img');
      const captionEl = document.getElementById('image-lightbox-caption');
      const closeEl = document.getElementById('image-lightbox-close');

      if (!lightbox || !imgEl || !captionEl || !closeEl) return;

      function closeLightbox() {
        lightbox.classList.remove('open');
        imgEl.src = '';
        captionEl.textContent = '';
      }

      closeEl.addEventListener('click', closeLightbox);
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          closeLightbox();
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeLightbox();
        }
      });

      document.querySelectorAll('.shot[data-fullsrc]').forEach((img) => {
        img.addEventListener('click', () => {
          const src = img.dataset.fullsrc || img.src;
          const caption = img.dataset.caption || '';
          imgEl.src = src;
          captionEl.textContent = caption;
          lightbox.classList.add('open');
        });
      });
    });
  </script>

{% endblock %}
